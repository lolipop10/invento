{% extends "base.html" %}

{% block title %}Scan Barcode - Inventory Management{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <!-- Last Scan Info -->
        {% if last_scan %}
        <div class="card border-info mb-3">
            <div class="card-header bg-info text-white">
                <h6><i class="fas fa-clock"></i> Dernier Scan</h6>
            </div>
            <div class="card-body p-2">
                <div class="row text-center">
                    <div class="col-3">
                        <small><strong>Lot:</strong></small><br>
                        <span class="badge bg-primary">{{ last_scan.lot }}</span>
                    </div>
                    <div class="col-3">
                        <small><strong>Article:</strong></small><br>
                        {{ last_scan.code_article }}
                    </div>
                    <div class="col-3">
                        <small><strong>Poids:</strong></small><br>
                        {% if last_scan.poids_physique is not none %}
                            {{ "%.1f"|format(last_scan.poids_physique) }} kg
                        {% else %}
                            -
                        {% endif %}
                    </div>
                    <div class="col-3">
                        <small><strong>Heure:</strong></small><br>
                        {{ last_scan.date_scan[11:16] if last_scan.date_scan else '-' }}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Mode Selection -->
        <div class="card mb-3">
            <div class="card-body p-2">
                <div class="btn-group w-100" role="group">
                    <button type="button" class="btn btn-primary active" id="btn-mode-scanner" onclick="switchMode('scanner')">
                        <i class="fas fa-barcode"></i> Douchette
                    </button>
                    <button type="button" class="btn btn-outline-primary" id="btn-mode-camera" onclick="switchMode('camera')">
                        <i class="fas fa-camera"></i> Caméra
                    </button>
                </div>
            </div>
        </div>

        <!-- SCANNER MODE (Douchette) -->
        <div id="scanner-mode">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4><i class="fas fa-qrcode"></i> Scanner Code-Barres - Douchette</h4>
                </div>
                <div class="card-body">
                    <form method="POST">
                        <div class="mb-4">
                            <label for="barcode" class="form-label">
                                <i class="fas fa-barcode"></i> Code-barres (28 caractères)
                            </label>
                            <input type="text" class="form-control scanner-input" id="barcode" name="barcode" 
                                   placeholder="Scannez ou saisissez le code-barres" autofocus required>
                            <div class="form-text">Format: 28 caractères - Code Article (pos 8-18), Lot (pos 18-28)</div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="poids" class="form-label">
                                        <i class="fas fa-weight"></i> Poids Physique (kg)
                                    </label>
                                    <input type="number" class="form-control" id="poids" name="poids" 
                                           step="0.01" min="0" placeholder="0 = auto depuis MB52">
                                    <div class="form-text">Laisser vide pour récupération auto depuis MB52</div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-comment"></i> Remarques
                                    </label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="remarque" 
                                               value="Bobine NC" id="remarque1">
                                        <label class="form-check-label" for="remarque1">Bobine NC</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="remarque" 
                                               value="Bobine Abimé" id="remarque2">
                                        <label class="form-check-label" for="remarque2">Bobine Abimé</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="remarque" 
                                               value="Bobine Non Séparé" id="remarque3">
                                        <label class="form-check-label" for="remarque3">Bobine Non Séparé</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                            <button type="submit" class="btn btn-primary btn-lg btn-custom me-md-2">
                                <i class="fas fa-plus"></i> Ajouter à l'Inventaire
                            </button>
                            <a href="{{ url_for('dashboard') }}" class="btn btn-secondary btn-lg btn-custom">
                                <i class="fas fa-arrow-left"></i> Retour
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- CAMERA MODE -->
        <div id="camera-mode" style="display: none;">
            <div class="card">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0"><i class="fas fa-camera"></i> Scan par Caméra</h4>
                    <div>
                        <span class="badge bg-light text-dark me-2" id="scan-count">Scans: 0</span>
                        <span class="badge bg-warning text-dark" id="camera-status-badge">Arrêté</span>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Camera Preview -->
                    <div class="position-relative mb-3" style="background: #000; border-radius: 10px; overflow: hidden;">
                        <video id="camera-preview" class="w-100" style="max-height: 600px; display: block;" autoplay playsinline muted></video>
                        
                        <!-- Scan Line Animation -->
                        <div id="scan-line-container" class="position-absolute top-0 start-0 w-100 h-100" style="pointer-events: none; display: none;">
                            <div class="scan-line"></div>
                        </div>

                        <!-- Success Flash -->
                        <div id="scan-success-flash" class="position-absolute top-0 start-0 w-100 h-100 bg-success" style="display: none; opacity: 0;"></div>

                        <!-- Target Box -->
                        <div class="position-absolute top-50 start-50 translate-middle" style="pointer-events: none;">
                            <div class="scan-target-box"></div>
                        </div>

                        <!-- Status Overlay -->
                        <div id="camera-overlay" class="position-absolute bottom-0 start-0 w-100 p-3 text-white text-center" style="background: linear-gradient(transparent, rgba(0,0,0,0.7));">
                            <i class="fas fa-qrcode fa-2x mb-2"></i>
                            <p class="mb-0">Positionnez le code-barres dans le cadre</p>
                        </div>
                    </div>

                    <!-- Status Messages -->
                    <div id="camera-message" class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Cliquez sur "Démarrer" pour activer la caméra
                    </div>

                    <!-- Last Scanned Result -->
                    <div id="camera-last-scan" class="alert alert-success" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1"><i class="fas fa-check-circle"></i> Scan réussi!</h6>
                                <div class="row small">
                                    <div class="col-4"><strong>Lot:</strong> <span id="cam-last-lot">-</span></div>
                                    <div class="col-4"><strong>Article:</strong> <span id="cam-last-code">-</span></div>
                                    <div class="col-4"><strong>Poids:</strong> <span id="cam-last-weight">-</span> kg</div>
                                </div>
                            </div>
                            <button class="btn btn-sm btn-outline-success" onclick="closeLastScanAlert()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Camera Controls -->
                    <div class="d-flex gap-2 justify-content-center mb-3">
                        <button type="button" class="btn btn-success btn-lg" id="btn-start-camera">
                            <i class="fas fa-play"></i> Démarrer
                        </button>
                        <button type="button" class="btn btn-danger btn-lg" id="btn-stop-camera" style="display: none;">
                            <i class="fas fa-stop"></i> Arrêter
                        </button>
                        <button type="button" class="btn btn-warning btn-lg" id="btn-toggle-torch" style="display: none;" disabled>
                            <i class="fas fa-lightbulb"></i> Flash
                        </button>
                        <button type="button" class="btn btn-info btn-lg" id="btn-switch-camera" style="display: none;">
                            <i class="fas fa-sync-alt"></i> Changer
                        </button>
                        <button type="button" class="btn btn-secondary btn-lg" id="btn-zoom-in" style="display: none;">
                            <i class="fas fa-search-plus"></i>
                        </button>
                    </div>

                    <!-- Zoom Control -->
                    <div id="zoom-control" class="mb-3" style="display: none;">
                        <label for="zoom-range" class="form-label">
                            <i class="fas fa-search"></i> Zoom: <span id="zoom-level">1.0</span>x
                        </label>
                        <input type="range" class="form-range" id="zoom-range" min="1" max="5" step="0.1" value="1">
                        <small class="text-muted">Ajustez le zoom pour les petits codes-barres</small>
                    </div>

                    <!-- Camera Settings -->
                    <div class="card bg-light">
                        <div class="card-body">
                            <h6 class="card-title"><i class="fas fa-cog"></i> Paramètres</h6>
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="continuous-scan" checked>
                                        <label class="form-check-label" for="continuous-scan">Scan continu</label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="auto-weight" checked>
                                        <label class="form-check-label" for="auto-weight">Poids auto (MB52)</label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="sound-feedback" checked>
                                        <label class="form-check-label" for="sound-feedback">Son activé</label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="hd-mode" checked>
                                        <label class="form-check-label" for="hd-mode">Mode HD (résolution max)</label>
                                    </div>
                                </div>
                            </div>
                            <div class="alert alert-info mt-2 mb-0 small">
                                <i class="fas fa-lightbulb"></i> <strong>Astuce:</strong> Pour les grands codes imprimés, gardez la caméra à ~20-40cm selon la taille de l'étiquette, activez Mode HD si disponible.
                            </div>
                        </div>
                    </div>

                    <div class="text-center mt-3">
                        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Retour au Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Instructions Card -->
        <div class="card mt-4">
            <div class="card-header">
                <h5><i class="fas fa-info-circle"></i> Instructions</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-barcode"></i> Mode Douchette:</h6>
                        <ul class="mb-0">
                            <li>Scannez avec votre lecteur code-barres</li>
                            <li>Format: 28 caractères exactement</li>
                            <li>Poids auto-rempli depuis MB52 si vide</li>
                            <li>Validation manuelle requise</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-camera"></i> Mode Caméra:</h6>
                        <ul class="mb-0">
                            <li>Détection automatique des codes-barres (native si disponible)</li>
                            <li>Enregistrement automatique et instantané</li>
                            <li>Feedback visuel et sonore</li>
                            <li>Scan continu sans interruption (option)</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* --- Styles repris et légers ajustements --- */
.scanner-input {
    font-size: 1.2rem;
    padding: 15px;
    border: 2px solid #007bff;
    border-radius: 10px;
}

.scanner-input:focus {
    border-color: #0056b3;
    box-shadow: 0 0 10px rgba(0, 123, 255, 0.5);
}

#camera-preview {
    object-fit: contain;
    border: 3px solid #28a745;
    background: #000;
}

.scan-line {
    width: 100%;
    height: 2px;
    background: linear-gradient(90deg, transparent, #00ff00, #00ff00, transparent);
    position: absolute;
    top: 0;
    animation: scanAnimation 2s linear infinite;
    box-shadow: 0 0 10px #00ff00;
}

@keyframes scanAnimation {
    0% { top: 0; }
    100% { top: 100%; }
}

.scan-target-box {
    width: 420px;
    height: 140px;
    border: 3px solid #00ff00;
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(0, 255, 0, 0.5), inset 0 0 20px rgba(0, 255, 0, 0.2);
    animation: targetPulse 2s ease-in-out infinite;
}

@keyframes targetPulse {
    0%, 100% { opacity: 0.7; transform: scale(1); }
    50% { opacity: 1; transform: scale(1.02); }
}

#scan-success-flash {
    transition: opacity 0.3s;
}

.btn-custom {
    border-radius: 25px;
    padding: 10px 30px;
    font-weight: 600;
}

.btn-group .btn.active {
    background-color: #0056b3;
    border-color: #0056b3;
}
</style>

{% endblock %}

{% block scripts %}
<!-- ZXing fallback library (kept as fallback) -->
<script src="https://unpkg.com/@zxing/library@0.20.0/umd/index.min.js"></script>

<script>
/* =========================
   Camera scanning improved
   ========================= */

let isScanning = false;
let currentStream = null;
let codeReader = null;
let scanCount = 0;
let lastScannedCode = '';
let lastScanTime = 0;
const DEBOUNCE_TIME = 1200; // ms anti-doublon
const MIN_INTERVAL = 400; // petite protection
const desiredFormats = ['code_128', 'code_39', 'ean_13', 'ean_8']; // pour BarcodeDetector

// audio feedback
const successSound = new Audio('data:audio/wav;base64,UklGRi4AAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQoAAAAAAAAAAAAAAAA=');
const errorSound = new Audio('data:audio/wav;base64,UklGRi4AAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQoAAAAAAAAAAAAAAAA=');

function updateCameraMessage(message, type='info') {
    const msgDiv = document.getElementById('camera-message');
    if (!msgDiv) return;
    msgDiv.className = `alert alert-${type}`;
    const icon = type==='success' ? 'check-circle' : type==='danger' ? 'exclamation-triangle' : 'info-circle';
    msgDiv.innerHTML = `<i class="fas fa-${icon}"></i> ${message}`;
}

function updateStatusBadge(status) {
    const badge = document.getElementById('camera-status-badge');
    if (!badge) return;
    if (status === 'running') {
        badge.textContent = 'En cours';
        badge.className = 'badge bg-success text-white';
    } else if (status === 'error') {
        badge.textContent = 'Erreur';
        badge.className = 'badge bg-danger text-white';
    } else {
        badge.textContent = 'Arrêté';
        badge.className = 'badge bg-warning text-dark';
    }
}

function showSuccessFlash() {
    const flash = document.getElementById('scan-success-flash');
    if (!flash) return;
    flash.style.display = 'block';
    flash.style.opacity = '0.6';
    setTimeout(()=> {
        flash.style.opacity = '0';
        setTimeout(()=> flash.style.display = 'none', 300);
    }, 150);
}

function playSound(success=true) {
    if (!document.getElementById('sound-feedback')?.checked) return;
    try { (success ? successSound : errorSound).play().catch(()=>{}); } catch(e) {}
}

function canUseBarcodeDetector() {
    return ('BarcodeDetector' in window);
}

async function getHighResConstraints() {
    // demande une résolution élevée si l'utilisateur a activé HD dans UI
    const hd = document.getElementById('hd-mode')?.checked;
    if (!hd) {
        return { video: { facingMode: { ideal: 'environment' }, width: { ideal: 1280 }, height: { ideal: 720 } } };
    }
    // demander une résolution plus élevée, le navigateur choisira la meilleure dispo
    return {
        video: {
            facingMode: { ideal: 'environment' },
            width: { ideal: 3840, max: 3840 },
            height: { ideal: 2160, max: 2160 },
            aspectRatio: { ideal: 16/9 }
        }
    };
}

async function startCamera() {
    if (isScanning) return;
    updateCameraMessage('Initialisation de la caméra...', 'info');

    try {
        const constraints = await getHighResConstraints();
        currentStream = await navigator.mediaDevices.getUserMedia(constraints);

        const video = document.getElementById('camera-preview');
        video.srcObject = currentStream;
        await video.play();

        // update UI buttons
        document.getElementById('btn-start-camera').style.display = 'none';
        document.getElementById('btn-stop-camera').style.display = 'inline-block';
        document.getElementById('scan-line-container').style.display = 'block';

        // Detect capabilities (torch / zoom)
        try {
            const track = currentStream.getVideoTracks()[0];
            const caps = track.getCapabilities ? track.getCapabilities() : {};
            // torch
            const btnTorch = document.getElementById('btn-toggle-torch');
            if (caps.torch) {
                btnTorch.style.display = 'inline-block';
                btnTorch.disabled = false;
            } else {
                btnTorch.style.display = 'none';
            }
            // zoom
            if (caps.zoom) {
                document.getElementById('btn-zoom-in').style.display = 'inline-block';
                const zoomControl = document.getElementById('zoom-control');
                const zoomRange = document.getElementById('zoom-range');
                zoomControl.style.display = 'block';
                zoomRange.min = caps.zoom.min || 1;
                zoomRange.max = caps.zoom.max || 5;
                zoomRange.value = caps.zoom.min || 1;
                zoomRange.oninput = async function() {
                    const v = parseFloat(this.value);
                    document.getElementById('zoom-level').textContent = v.toFixed(1);
                    try { await track.applyConstraints({ advanced: [{ zoom: v }] }); } catch(e){}
                };
            }
        } catch(e){ console.log('cap check err', e); }

        updateCameraMessage('Caméra active - en attente de code...', 'success');
        updateStatusBadge('running');
        isScanning = true;

        // choose detection strategy: native BarcodeDetector (fast & robust) OR ZXing fallback
        if (canUseBarcodeDetector()) {
            // check supported formats
            try {
                const supported = await BarcodeDetector.getSupportedFormats();
                const hasWanted = desiredFormats.some(f => supported.includes(f));
                if (hasWanted) {
                    startNativeDetection();
                    return;
                }
            } catch (e) {
                // ignore and fallback
                console.warn('BarcodeDetector check failed', e);
            }
        }
        // fallback ZXing
        startZXingDetection();

    } catch (err) {
        console.error('Erreur caméra:', err);
        updateCameraMessage(`Erreur: ${err.message || err}`, 'danger');
        updateStatusBadge('error');
        stopCamera();
    }
}

async function stopCamera() {
    if (!isScanning && !currentStream) return;
    try {
        // stop ZXing if used
        if (codeReader && typeof codeReader.reset === 'function') {
            try { codeReader.reset(); } catch(e){}
            codeReader = null;
        }
        if (currentStream) {
            currentStream.getTracks().forEach(t => { try { t.stop(); } catch(e){} });
            currentStream = null;
        }
        const video = document.getElementById('camera-preview');
        if (video) video.srcObject = null;

        isScanning = false;
        document.getElementById('btn-start-camera').style.display = 'inline-block';
        document.getElementById('btn-stop-camera').style.display = 'none';
        document.getElementById('btn-toggle-torch').style.display = 'none';
        document.getElementById('btn-zoom-in').style.display = 'none';
        document.getElementById('scan-line-container').style.display = 'none';
        document.getElementById('zoom-control').style.display = 'none';

        updateCameraMessage('Caméra arrêtée', 'info');
        updateStatusBadge('stopped');
    } catch (e) {
        console.error('Erreur arrêt caméra:', e);
    }
}

async function startNativeDetection() {
    // Utilise l'API BarcodeDetector si disponible (plus fiable/performante pour les codes larges)
    const video = document.getElementById('camera-preview');
    const opts = { formats: desiredFormats };
    let detector;
    try {
        detector = new BarcodeDetector(opts);
    } catch (e) {
        console.warn('BarcodeDetector construction failed', e);
        startZXingDetection();
        return;
    }

    // On lit frames via createImageBitmap pour une meilleure compatibilité
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');

    async function loop() {
        if (!isScanning) return;
        try {
            // dimension canvas adaptée à la vidéo
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // convert to ImageBitmap if supported (plus rapide)
            let imageBitmap;
            try {
                imageBitmap = await createImageBitmap(canvas);
            } catch (e) {
                imageBitmap = null;
            }

            const results = imageBitmap ? await detector.detect(imageBitmap) : await detector.detect(canvas);
            if (results && results.length) {
                // prend le premier résultat utile
                for (const res of results) {
                    const code = res.rawValue?.trim();
                    if (code && allowProcessCode(code)) {
                        handleDetectedCode(code);
                        break;
                    }
                }
            }
        } catch (e) {
            // ignore occasional detection errors
            // console.log('native detect err', e);
        } finally {
            // petite attente pour limiter charge CPU
            setTimeout(() => {
                requestAnimationFrame(loop);
            }, 50);
        }
    }

    requestAnimationFrame(loop);
    updateCameraMessage('Détection native activée', 'success');
}

function startZXingDetection() {
    // fallback ZXing.decodeFromVideoDevice
    const video = document.getElementById('camera-preview');
    try {
        codeReader = new ZXing.BrowserMultiFormatReader();
        // on lance la détection continue; callback exécutée pour chaque frame décodée
        // récupérer deviceId si possible
        const track = currentStream.getVideoTracks()[0];
        const settings = track.getSettings ? track.getSettings() : {};
        const deviceId = settings.deviceId;
        codeReader.decodeFromVideoDevice(deviceId || null, video, (result, err) => {
            if (result) {
                const code = result.text?.trim();
                if (code && allowProcessCode(code)) {
                    handleDetectedCode(code);
                }
            }
            // ignore errors
        });
        updateCameraMessage('Détection ZXing activée', 'success');
    } catch (e) {
        console.error('ZXing start failed', e);
        updateCameraMessage('Erreur initialisation ZXing', 'danger');
    }
}

function allowProcessCode(code) {
    // anti-doublon basique
    const now = Date.now();
    if (code === lastScannedCode && (now - lastScanTime) < DEBOUNCE_TIME) return false;
    if ((now - lastScanTime) < MIN_INTERVAL) return false;
    // format minimal check (tu peux ajuster selon règle 28 chars)
    return true;
}

function handleDetectedCode(code) {
    const now = Date.now();
    lastScannedCode = code;
    lastScanTime = now;
    scanCount++;
    document.getElementById('scan-count').textContent = `Scans: ${scanCount}`;
    showSuccessFlash();
    playSound(true);

    // si non-formaté 28 caractères, afficher avertissement
    if (code.length !== 28) {
        updateCameraMessage(`Code détecté (format inattendu ${code.length}): ${code.substring(0,40)}...`, 'warning');
        // si tu veux ignorer, return; ici on continue pour permettre tests
    } else {
        updateCameraMessage(`Code détecté: ${code.substring(0,20)}...`, 'success');
    }

    // extraire article/lot comme avant
    const codeArticle = code.substring(8, 18);
    const lot = code.substring(18, 28);

    // afficher temporairement dans UI caméra
    document.getElementById('cam-last-lot').textContent = lot;
    document.getElementById('cam-last-code').textContent = codeArticle;
    document.getElementById('cam-last-weight').textContent = document.getElementById('auto-weight')?.checked ? 'Auto' : '-';
    document.getElementById('camera-last-scan').style.display = 'block';

    // Envoi au serveur (POST vers endpoint scan)
    sendScanToServer(code).then(ok => {
        if (!ok) {
            playSound(false);
            updateCameraMessage('Erreur lors de l\'enregistrement serveur', 'danger');
        } else {
            updateCameraMessage(`Lot ${lot} enregistré`, 'success');
        }
    });

    // si mode non-continu, on arrête
    if (!document.getElementById('continuous-scan')?.checked) {
        setTimeout(()=> stopCamera(), 800);
    }
}

async function sendScanToServer(barcode) {
    try {
        const autoWeight = document.getElementById('auto-weight')?.checked;
        const formData = new FormData();
        formData.append('barcode', barcode);
        if (!autoWeight) {
            formData.append('poids', '0');
        }
        const res = await fetch('{{ url_for("scan") }}', { method: 'POST', body: formData });
        return res.ok;
    } catch (e) {
        console.error('sendScan error', e);
        return false;
    }
}

// toggles & utility
async function toggleTorch() {
    if (!currentStream) return;
    try {
        const track = currentStream.getVideoTracks()[0];
        const caps = track.getCapabilities ? track.getCapabilities() : {};
        if (!caps.torch) {
            updateCameraMessage('Flash non disponible', 'warning');
            return;
        }
        const settings = track.getSettings ? track.getSettings() : {};
        const current = settings.torch || false;
        await track.applyConstraints({ advanced: [{ torch: !current }] });
        updateCameraMessage(`Flash ${!current ? 'activé' : 'désactivé'}`, 'info');
    } catch (e) {
        console.error('torch err', e);
        updateCameraMessage('Impossible d\'activer le flash', 'warning');
    }
}

function switchMode(mode) {
    const scannerMode = document.getElementById('scanner-mode');
    const cameraMode = document.getElementById('camera-mode');
    const btnScanner = document.getElementById('btn-mode-scanner');
    const btnCamera = document.getElementById('btn-mode-camera');

    if (mode === 'scanner') {
        scannerMode.style.display = 'block';
        cameraMode.style.display = 'none';
        btnScanner.classList.add('active');
        btnScanner.classList.remove('btn-outline-primary');
        btnScanner.classList.add('btn-primary');
        btnCamera.classList.remove('active');
        btnCamera.classList.add('btn-outline-primary');
        btnCamera.classList.remove('btn-primary');

        stopCamera();
        setTimeout(()=> document.getElementById('barcode')?.focus(), 100);
    } else {
        scannerMode.style.display = 'none';
        cameraMode.style.display = 'block';
        btnCamera.classList.add('active');
        btnCamera.classList.remove('btn-outline-primary');
        btnCamera.classList.add('btn-primary');
        btnScanner.classList.remove('active');
        btnScanner.classList.add('btn-outline-primary');
        btnScanner.classList.remove('btn-primary');
    }
}

function closeLastScanAlert() {
    document.getElementById('camera-last-scan').style.display = 'none';
}

// Event listeners
document.getElementById('btn-start-camera')?.addEventListener('click', startCamera);
document.getElementById('btn-stop-camera')?.addEventListener('click', stopCamera);
document.getElementById('btn-toggle-torch')?.addEventListener('click', toggleTorch);
document.getElementById('btn-switch-camera')?.addEventListener('click', async function() {
    // change camera by cycling device list: simple approach is stop/start and prompt user
    await stopCamera();
    // flip camera by toggling facingMode preference (simple)
    document.getElementById('hd-mode').checked = document.getElementById('hd-mode').checked; // noop: placeholder
    startCamera();
});

document.getElementById('btn-zoom-in')?.addEventListener('click', function() {
    const zoomControl = document.getElementById('zoom-control');
    if (!zoomControl) return;
    zoomControl.style.display = (zoomControl.style.display === 'block') ? 'none' : 'block';
});

// barcode input constraints
document.getElementById('barcode')?.addEventListener('input', function(e) {
    let value = e.target.value;
    if (value.length > 28) e.target.value = value.substring(0,28);
});
document.getElementById('barcode')?.addEventListener('keyup', function(e) {
    if (e.target.value.length === 28 && e.key === 'Enter') document.getElementById('poids')?.focus();
});

// cleanup
window.addEventListener('beforeunload', () => { stopCamera(); });
</script>
{% endblock %}
