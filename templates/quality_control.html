{% extends "base.html" %}

{% block title %}Contrôle Qualité - {{ company_name|default('Inventory Management') }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <h2><i class="fas fa-check-circle"></i> Contrôle Qualité</h2>
            <button class="btn btn-success" id="exportQualityBtn">
                <i class="fas fa-download"></i> Exporter vers Excel
            </button>
        </div>
    </div>

    <!-- Statistiques -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center border-success">
                <div class="card-body">
                    <i class="fas fa-check-double fa-2x text-success mb-2"></i>
                    <h3 class="text-success">{{ stats.conformes if stats else 0 }}</h3>
                    <small>Conformes</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-danger">
                <div class="card-body">
                    <i class="fas fa-times-circle fa-2x text-danger mb-2"></i>
                    <h3 class="text-danger">{{ stats.non_conformes if stats else 0 }}</h3>
                    <small>Non Conformes</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-warning">
                <div class="card-body">
                    <i class="fas fa-clock fa-2x text-warning mb-2"></i>
                    <h3 class="text-warning">{{ stats.en_attente if stats else 0 }}</h3>
                    <small>En Attente</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-info">
                <div class="card-body">
                    <i class="fas fa-percentage fa-2x text-info mb-2"></i>
                    <h3 class="text-info">{{ "%.1f"|format(stats.taux_conformite if stats else 0) }}%</h3>
                    <small>Taux Conformité</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtres -->
    <div class="card mb-3">
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Filtrer par statut</label>
                    <select name="statut" class="form-select" onchange="this.form.submit()">
                        <option value="" {% if not filter_statut %}selected{% endif %}>Tous</option>
                        <option value="CONFORME" {% if filter_statut == 'CONFORME' %}selected{% endif %}>✓ Conformes</option>
                        <option value="NON_CONFORME" {% if filter_statut == 'NON_CONFORME' %}selected{% endif %}>✗ Non Conformes</option>
                        <option value="EN_ATTENTE" {% if filter_statut == 'EN_ATTENTE' %}selected{% endif %}>⏳ En Attente</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Décision finale</label>
                    <select name="decision" class="form-select" onchange="this.form.submit()">
                        <option value="" {% if not filter_decision %}selected{% endif %}>Toutes</option>
                        <option value="A_LIVRER" {% if filter_decision == 'A_LIVRER' %}selected{% endif %}>À Livrer</option>
                        <option value="A_TRANSFORMER" {% if filter_decision == 'A_TRANSFORMER' %}selected{% endif %}>À Transformer</option>
                        <option value="A_RECYCLER" {% if filter_decision == 'A_RECYCLER' %}selected{% endif %}>À Recycler</option>
                        <option value="MAGASIN_NC" {% if filter_decision == 'MAGASIN_NC' %}selected{% endif %}>Magasin NC</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Rechercher un lot</label>
                    <input type="text" class="form-control" name="search" value="{{ search_term }}" 
                           placeholder="Numéro de lot...">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-filter"></i> Filtrer
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Actions groupées -->
    <div class="card mb-3">
        <div class="card-body">
            <form method="POST" action="{{ url_for('quality_batch_update') }}" id="batchUpdateForm">
                <div class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label class="form-label">Action groupée</label>
                        <select name="statut" class="form-select" required>
                            <option value="">Choisir un statut...</option>
                            <option value="CONFORME">✓ Marquer CONFORME</option>
                            <option value="NON_CONFORME">✗ Marquer NON_CONFORME</option>
                            <option value="EN_ATTENTE">⏳ Marquer EN_ATTENTE</option>
                        </select>
                    </div>
                    <div class="col-md-9">
                        <button type="submit" class="btn btn-warning" onclick="return confirmBatchUpdate()">
                            <i class="fas fa-edit"></i> Appliquer aux lots sélectionnés
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="selectAll()">
                            <i class="fas fa-check-square"></i> Tout sélectionner
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="deselectAll()">
                            <i class="fas fa-square"></i> Tout désélectionner
                        </button>
                        <span id="selectedCount" class="badge bg-info ms-2">0 sélectionné(s)</span>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Liste des lots -->
    <div class="card">
        <div class="card-header">
            <h5><i class="fas fa-list"></i> Lots d'inventaire ({{ lots|length }} résultats)</h5>
        </div>
        <div class="card-body">
            {% if lots %}
            <div class="table-responsive">
                <table class="table table-sm table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th><input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()"></th>
                            <th>Lot</th>
                            <th>Code Article</th>
                            <th>Poids (kg)</th>
                            <th>Statut Qualité</th>
                            <th>Non-Conformité</th>
                            <th>Décision</th>
                            <th>Contrôleur</th>
                            <th>Date Contrôle</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for lot in lots %}
                        <tr class="
                            {% if lot.statut_qualite == 'CONFORME' %}table-success
                            {% elif lot.statut_qualite == 'NON_CONFORME' %}table-danger
                            {% else %}table-warning
                            {% endif %}
                        ">
                            <td>
                                <input type="checkbox" name="lots" value="{{ lot.lot }}" 
                                       form="batchUpdateForm" class="lot-checkbox" 
                                       onchange="updateSelectedCount()">
                            </td>
                            <td><strong>{{ lot.lot }}</strong></td>
                            <td>{{ lot.code_article or '-' }}</td>
                            <td>{{ "%.2f"|format(lot.poids_physique) if lot.poids_physique else '-' }}</td>
                            <td>
                                {% if lot.statut_qualite == 'CONFORME' %}
                                <span class="badge bg-success">✓ Conforme</span>
                                {% elif lot.statut_qualite == 'NON_CONFORME' %}
                                <span class="badge bg-danger">✗ Non Conforme</span>
                                {% else %}
                                <span class="badge bg-warning text-dark">⏳ En Attente</span>
                                {% endif %}
                            </td>
                            <td>{{ lot.non_conformite or '-' }}</td>
                            <td>
                                {% if lot.decision_finale %}
                                <span class="badge bg-info">{{ lot.decision_finale.replace('_', ' ') }}</span>
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td>{{ lot.controleur_nom or '-' }}</td>
                            <td>{{ lot.date_controle[:19] if lot.date_controle else '-' }}</td>
                            <td>
                                <button class="btn btn-sm btn-primary" 
                                        onclick="openQualityModal('{{ lot.lot }}', '{{ lot.code_article }}', '{{ lot.statut_qualite }}', '{{ lot.non_conformite or '' }}', '{{ lot.decision_finale or '' }}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center text-muted py-4">
                <i class="fas fa-inbox fa-3x mb-3"></i>
                <p>Aucun lot trouvé</p>
                <a href="{{ url_for('scan') }}" class="btn btn-primary">
                    <i class="fas fa-qrcode"></i> Scanner des lots
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal Contrôle Qualité -->
<div class="modal fade" id="qualityModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('save_quality_control') }}">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-check-circle"></i> Contrôle Qualité - Lot <span id="modalLotNumber"></span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="lot" id="modalLot">
                    
                    <div class="mb-3">
                        <label class="form-label"><strong>Code Article:</strong></label>
                        <input type="text" class="form-control" id="modalCodeArticle" readonly>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label"><strong>Statut Qualité:</strong> <span class="text-danger">*</span></label>
                        <select name="statut_qualite" class="form-select" id="modalStatut" required>
                            <option value="">Choisir...</option>
                            <option value="CONFORME">✓ CONFORME</option>
                            <option value="NON_CONFORME">✗ NON_CONFORME</option>
                            <option value="EN_ATTENTE">⏳ EN_ATTENTE</option>
                        </select>
                    </div>
                    
                    <div class="mb-3" id="nonConformiteDiv">
                        <label class="form-label"><strong>Description Non-Conformité:</strong></label>
                        <textarea name="non_conformite" class="form-control" rows="3" 
                                  id="modalNonConformite" placeholder="Détails de la non-conformité..."></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label"><strong>Décision Finale:</strong></label>
                        <select name="decision_finale" class="form-select" id="modalDecision">
                            <option value="">Aucune décision</option>
                            <option value="A_LIVRER">À Livrer</option>
                            <option value="A_TRANSFORMER">À Transformer</option>
                            <option value="A_RECYCLER">À Recycler</option>
                            <option value="MAGASIN_NC">Magasin NC</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Export Password -->
<div class="modal fade" id="exportQualityModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-lock"></i> Authentification Export Qualité
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Entrez le mot de passe d'export.
                </div>
                <input type="password" class="form-control" id="qualityPasswordInput" 
                       placeholder="Mot de passe d'export">
                <div id="qualityPasswordError" class="alert alert-danger mt-3 d-none"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-success" id="verifyQualityPasswordBtn">
                    <i class="fas fa-download"></i> Exporter
                </button>
            </div>
        </div>
    </div>
</div>

<form id="exportQualityForm" method="GET" action="{{ url_for('quality_export') }}" style="display: none;"></form>
{% endblock %}

{% block scripts %}
<script>
let qualityModal;
let exportQualityModal;

document.addEventListener('DOMContentLoaded', function() {
    qualityModal = new bootstrap.Modal(document.getElementById('qualityModal'));
    exportQualityModal = new bootstrap.Modal(document.getElementById('exportQualityModal'));
    
    // Gestion du statut qualité
    document.getElementById('modalStatut').addEventListener('change', function() {
        const nonConformiteDiv = document.getElementById('nonConformiteDiv');
        if (this.value === 'NON_CONFORME') {
            nonConformiteDiv.style.display = 'block';
            document.getElementById('modalNonConformite').required = true;
        } else {
            nonConformiteDiv.style.display = 'none';
            document.getElementById('modalNonConformite').required = false;
        }
    });
    
    // Export
    document.getElementById('exportQualityBtn').addEventListener('click', function(e) {
        e.preventDefault();
        exportQualityModal.show();
        setTimeout(() => {
            document.getElementById('qualityPasswordInput').focus();
        }, 500);
    });
    
    document.getElementById('verifyQualityPasswordBtn').addEventListener('click', async function() {
        const password = document.getElementById('qualityPasswordInput').value;
        const errorDiv = document.getElementById('qualityPasswordError');
        const btn = this;
        
        if (!password) {
            errorDiv.textContent = 'Veuillez entrer un mot de passe';
            errorDiv.classList.remove('d-none');
            return;
        }
        
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Vérification...';
        errorDiv.classList.add('d-none');
        
        try {
            const response = await fetch('{{ url_for("verify_quality_export_password") }}', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ password: password })
            });
            
            const data = await response.json();
            
            if (data.success) {
                exportQualityModal.hide();
                document.getElementById('exportQualityForm').submit();
            } else {
                errorDiv.textContent = data.message || 'Mot de passe incorrect';
                errorDiv.classList.remove('d-none');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-download"></i> Exporter';
            }
        } catch (error) {
            errorDiv.textContent = 'Erreur de connexion';
            errorDiv.classList.remove('d-none');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-download"></i> Exporter';
        }
    });
    
    document.getElementById('qualityPasswordInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            document.getElementById('verifyQualityPasswordBtn').click();
        }
    });
});

function openQualityModal(lot, codeArticle, statut, nonConformite, decision) {
    document.getElementById('modalLot').value = lot;
    document.getElementById('modalLotNumber').textContent = lot;
    document.getElementById('modalCodeArticle').value = codeArticle;
    document.getElementById('modalStatut').value = statut;
    document.getElementById('modalNonConformite').value = nonConformite;
    document.getElementById('modalDecision').value = decision;
    
    // Afficher/masquer la non-conformité
    const nonConformiteDiv = document.getElementById('nonConformiteDiv');
    if (statut === 'NON_CONFORME') {
        nonConformiteDiv.style.display = 'block';
        document.getElementById('modalNonConformite').required = true;
    } else {
        nonConformiteDiv.style.display = 'none';
        document.getElementById('modalNonConformite').required = false;
    }
    
    qualityModal.show();
}

function updateSelectedCount() {
    const checked = document.querySelectorAll('.lot-checkbox:checked').length;
    document.getElementById('selectedCount').textContent = checked + ' sélectionné(s)';
}

function selectAll() {
    document.querySelectorAll('.lot-checkbox').forEach(cb => cb.checked = true);
    document.getElementById('selectAllCheckbox').checked = true;
    updateSelectedCount();
}

function deselectAll() {
    document.querySelectorAll('.lot-checkbox').forEach(cb => cb.checked = false);
    document.getElementById('selectAllCheckbox').checked = false;
    updateSelectedCount();
}

function toggleSelectAll() {
    const checked = document.getElementById('selectAllCheckbox').checked;
    document.querySelectorAll('.lot-checkbox').forEach(cb => cb.checked = checked);
    updateSelectedCount();
}

function confirmBatchUpdate() {
    const count = document.querySelectorAll('.lot-checkbox:checked').length;
    if (count === 0) {
        alert('Veuillez sélectionner au moins un lot');
        return false;
    }
    return confirm(`Êtes-vous sûr de vouloir mettre à jour ${count} lot(s) ?`);
}
</script>
{% endblock %}